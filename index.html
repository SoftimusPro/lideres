<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Control de Comidas - Escaneo QR</title>

<!-- iziToast (notificaciones) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/css/iziToast.min.css">

<style>
/* ----------------------------- */
/* Estilos originales (mantener) */
/* ----------------------------- */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  max-width: 900px;
  width: 100%;
  padding: 30px;
  margin: 0 auto;
}

h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 28px; }
.subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }

.tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
.tab {
  padding: 12px 24px; background: transparent; border: none; cursor: pointer;
  font-size: 16px; font-weight: bold; color: #666; border-bottom: 3px solid transparent;
  transition: all 0.3s;
}
.tab:hover { color: #667eea; }
.tab.active { color: #667eea; border-bottom-color: #667eea; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.scanner-section { background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px; }

#video-container {
  position: relative; width: 100%; max-width: 500px; margin: 0 auto 20px;
  border-radius: 10px; overflow: hidden; background: #000; display: none;
  height: auto;
}
#qr-video { width: 100%; height: 100%; display: block; object-fit: cover; }

#qr-canvas { display: none; }

.scan-region {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  width: 250px; height: 250px; border: 3px solid #00ff00;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
}

.meal-buttons {
  display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 20px;
}
.meal-btn {
  padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold;
  cursor: pointer; transition: all 0.3s; color: white;
}
.meal-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.meal-btn.desayuno { background: #ff9800; }
.meal-btn.almuerzo { background: #4caf50; }
.meal-btn.comida { background: #2196f3; }
.meal-btn.active { box-shadow: 0 0 0 3px rgba(255,255,255,0.5), 0 0 0 6px currentColor; }

.control-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
.btn { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }
.btn-secondary { background: #e0e0e0; color: #333; }
.btn-secondary:hover { background: #d0d0d0; }

.message { padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; text-align: center; display: none; animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
.message.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
.message.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
.message.warning { background: #fff3cd; color: #856404; border: 2px solid #ffeaa7; }

.info-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #1565c0; }

#manual-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
#manual-input:focus { outline: none; border-color: #667eea; }

.people-list { background: #f8f9fa; border-radius: 15px; padding: 20px; }
.people-list h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
.search-box { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; }
.search-box:focus { outline: none; border-color: #667eea; }

.person-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #667eea; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.person-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.person-code { font-weight: bold; color: #667eea; font-size: 16px; }
.person-date { font-size: 12px; color: #999; }

.meal-tags { display: flex; gap: 8px; flex-wrap: wrap; }
.meal-tag { padding: 6px 12px; border-radius: 5px; font-size: 13px; font-weight: bold; color: white; }
.meal-tag.desayuno { background: #ff9800; }
.meal-tag.almuerzo { background: #4caf50; }
.meal-tag.comida { background: #2196f3; }
.meal-tag.pendiente { background: #e0e0e0; color: #666; }

.stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
.stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.stat-number { font-size: 32px; font-weight: bold; color: #667eea; margin-bottom: 5px; }
.stat-label { font-size: 14px; color: #666; }

.clear-btn { width: 100%; padding: 12px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; font-weight: bold; font-size: 14px; }
.clear-btn:hover { background: #d32f2f; }

.history { background: #f8f9fa; border-radius: 15px; padding: 20px; max-height: 400px; overflow-y: auto; }
.history-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea; }
.history-item .date { font-weight: bold; color: #667eea; margin-bottom: 5px; }

.loading { text-align: center; padding: 20px; color: #667eea; font-weight: bold; }

/* ----------------------------- */
/* Optimizaci√≥n m√≥vil (sin tocar dise√±o) */
/* ----------------------------- */
@media (max-width: 768px) {
  .container { padding: 18px; }
  .tabs { gap: 6px; flex-wrap: wrap; }
  .tab { padding: 10px 12px; font-size: 14px; flex: 1; text-align: center; }
  .meal-buttons { grid-template-columns: 1fr; }
  .control-buttons { flex-direction: column; }
  #video-container { max-width: 100%; height: 50vh; }
  .scan-region { width: 180px; height: 180px; }
  .stat-number { font-size: 26px; }
  .person-code { font-size: 14px; }
}
</style>
</head>

<body>
  <div class="container">
    <h1>üçΩÔ∏è Control de Comidas</h1>
    <p class="subtitle">Sistema de registro con c√≥digo QR</p>

    <!-- Mensaje visible (backup) -->
    <div id="message" class="message" style="display:none;"></div>

    <!-- Pesta√±as -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab(event,'scanner')">üì∑ Registro</button>
      <button class="tab" onclick="switchTab(event,'people')">üë• Lista de Personas</button>
      <button class="tab" onclick="switchTab(event,'history')">üìã Historial</button>
    </div>

    <!-- TAB: SCANNER -->
    <div id="scanner-tab" class="tab-content active">
      <div class="info-box">
        üì± <strong>Opci√≥n 1:</strong> Selecciona el tipo de comida y escanea el c√≥digo QR<br>
        üíª <strong>Opci√≥n 2:</strong> Ingresa el c√≥digo manualmente en el campo de texto
      </div>

      <div class="meal-buttons" role="tablist">
        <button class="meal-btn desayuno" onclick="selectMeal(event,'desayuno')">üåÖ Desayuno</button>
        <button class="meal-btn almuerzo" onclick="selectMeal(event,'almuerzo')">‚òÄÔ∏è Almuerzo</button>
        <button class="meal-btn comida" onclick="selectMeal(event,'comida')">üåô Comida</button>
      </div>

      <div class="scanner-section">
        <div id="video-container">
          <video id="qr-video" autoplay playsinline muted></video>
          <canvas id="qr-canvas"></canvas>
          <div class="scan-region" aria-hidden="true"></div>
        </div>

        <input type="text" id="manual-input" placeholder="Ingresa el c√≥digo manualmente y presiona Enter" />

        <div class="control-buttons">
          <button class="btn btn-primary" id="start-btn" onclick="startScanner()">üì∑ Iniciar Esc√°ner</button>
          <button class="btn btn-secondary" id="stop-btn" onclick="stopScanner()" disabled>‚èπÔ∏è Detener</button>
        </div>

        <button class="btn btn-primary" style="width:100%" onclick="registerManual()">‚úÖ Registrar C√≥digo Manual</button>
      </div>
    </div>

    <!-- TAB: PEOPLE -->
    <div id="people-tab" class="tab-content">
      <div class="stats">
        <div class="stat-card"><div class="stat-number" id="total-people">0</div><div class="stat-label">Personas Hoy</div></div>
        <div class="stat-card"><div class="stat-number" id="total-meals">0</div><div class="stat-label">Comidas Hoy</div></div>
        <div class="stat-card"><div class="stat-number" id="pending-meals">0</div><div class="stat-label">Pendientes</div></div>
      </div>

      <div class="people-list">
        <h3>üë• Personas Registradas Hoy</h3>
        <input type="text" class="search-box" id="search-input" placeholder="üîç Buscar por c√≥digo..." onkeyup="filterPeople()" />
        <div id="people-container"></div>
      </div>
    </div>

    <!-- TAB: HISTORY -->
    <div id="history-tab" class="tab-content">
      <div class="history">
        <h3>üìã Historial (√∫ltimos 3 d√≠as)</h3>
        <div id="history-list"></div>
        <button class="clear-btn" onclick="clearOldData()">üóëÔ∏è Limpiar datos antiguos (m√°s de 3 d√≠as)</button>
      </div>
    </div>
  </div>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script>

  <script>
  /* -------------------------
     Variables y constantes
     ------------------------- */
  const STORAGE_KEY = 'meal_registrations';
  const DAYS_TO_KEEP = 3;
  const MAX_CODE_LENGTH = 200;
  let video = null;
  let canvas = null;
  let ctx = null;
  let selectedMeal = null;
  let isScanning = false;
  let scanAnimationId = null;

  /* -------------------------
     Inicializaci√≥n
     ------------------------- */
  document.addEventListener('DOMContentLoaded', () => {
    video = document.getElementById('qr-video');
    canvas = document.getElementById('qr-canvas');
    ctx = canvas.getContext('2d');

    document.getElementById('manual-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') registerManual();
    });

    loadHistory();
    loadPeopleList();
    cleanOldRecords();
    updateStats();
  });

  /* -------------------------
     Pesta√±as
     ------------------------- */
  function switchTab(evt, tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    if (evt && evt.target) evt.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');

    if (tabName !== 'scanner' && isScanning) stopScanner();

    if (tabName === 'people') { loadPeopleList(); updateStats(); }
    if (tabName === 'history') loadHistory();
  }

  /* -------------------------
     Selecci√≥n de comida
     ------------------------- */
  function selectMeal(evt, mealType) {
    selectedMeal = mealType;
    document.querySelectorAll('.meal-btn').forEach(btn => btn.classList.remove('active'));
    if (evt && evt.target) evt.target.classList.add('active');
    iziToast.info({ title: 'Tipo', message: getMealName(mealType), position: 'topCenter', timeout: 1800 });
  }

  function getMealName(mealType) {
    const map = { desayuno: 'Desayuno üåÖ', almuerzo: 'Almuerzo ‚òÄÔ∏è', comida: 'Comida üåô' };
    return map[mealType] || mealType;
  }

  /* -------------------------
     Scanner: iniciar / tick / detener
     ------------------------- */
  async function startScanner() {
    if (!selectedMeal) {
      iziToast.warning({ title: 'Atenci√≥n', message: 'Selecciona un tipo de comida antes', position: 'topCenter' });
      return;
    }
    if (isScanning) {
      iziToast.warning({ title: 'Atenci√≥n', message: 'El esc√°ner ya est√° activo', position: 'topCenter' });
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      video.setAttribute('playsinline', true);
      await video.play();

      document.getElementById('video-container').style.display = 'block';
      document.getElementById('start-btn').disabled = true;
      document.getElementById('stop-btn').disabled = false;
      isScanning = true;

      iziToast.show({ title: 'Esc√°ner', message: 'Apunta la c√°mara al c√≥digo QR', position: 'topCenter', timeout: 2000 });
      tick();
    } catch (err) {
      console.error('Error al iniciar c√°mara:', err);
      iziToast.error({ title: 'Error', message: 'No se pudo acceder a la c√°mara. Usa registro manual.', position: 'topCenter' });
      stopScanner();
    }
  }

  function tick() {
    if (!isScanning) return;
    try {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        if (video.videoWidth === 0 || video.videoHeight === 0) {
          scanAnimationId = requestAnimationFrame(tick);
          return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' });

        if (code && code.data) {
          // Al detectar: registrar y detener esc√°ner inmediatamente
          registerMeal(code.data, { fromScanner: true });
          // stopScanner() se llama dentro de registerMeal cuando es fromScanner:true y registro OK
          return;
        }
      }
    } catch (err) {
      console.error('Error en tick:', err);
    }
    scanAnimationId = requestAnimationFrame(tick);
  }

  function stopScanner() {
    isScanning = false;
    if (scanAnimationId) { cancelAnimationFrame(scanAnimationId); scanAnimationId = null; }
    try {
      if (video && video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(t => t.stop());
      }
    } catch (e) {
      console.warn('Error al detener tracks:', e);
    } finally {
      if (video) video.srcObject = null;
      document.getElementById('video-container').style.display = 'none';
      document.getElementById('start-btn').disabled = false;
      document.getElementById('stop-btn').disabled = true;
    }
  }

  /* -------------------------
     Registro manual
     ------------------------- */
  function registerManual() {
    const input = document.getElementById('manual-input');
    const code = (input.value || '').trim();
    if (!code) {
      iziToast.warning({ title: 'Atenci√≥n', message: 'Ingresa un c√≥digo v√°lido', position: 'topCenter' });
      return;
    }
    if (!selectedMeal) {
      iziToast.warning({ title: 'Atenci√≥n', message: 'Selecciona tipo de comida', position: 'topCenter' });
      return;
    }
    registerMeal(code, { fromScanner: false });
    input.value = '';
  }

  /* -------------------------
     Registro principal
     options: { fromScanner: boolean }
     ------------------------- */
  function registerMeal(qrCode, options = { fromScanner: false }) {
    if (!qrCode || typeof qrCode !== 'string') {
      iziToast.error({ title: 'Error', message: 'C√≥digo inv√°lido', position: 'topCenter' });
      return;
    }
    if (qrCode.length > MAX_CODE_LENGTH) {
      iziToast.error({ title: 'Error', message: 'C√≥digo demasiado largo', position: 'topCenter' });
      return;
    }
    qrCode = qrCode.trim();

    if (!selectedMeal) {
      iziToast.warning({ title: 'Atenci√≥n', message: 'Selecciona un tipo de comida', position: 'topCenter' });
      return;
    }

    const todayStr = getTodayDate();
    const regs = getRegistrations();

    if (!regs[todayStr]) regs[todayStr] = {};
    if (!regs[todayStr][qrCode]) regs[todayStr][qrCode] = [];

    if (regs[todayStr][qrCode].includes(selectedMeal)) {
      iziToast.error({ title: 'Duplicado', message: `La tarjeta ya registr√≥ ${getMealName(selectedMeal)} hoy`, position: 'topCenter' });
      // Si vino del scanner y ya estaba registrado, cerramos scanner para evitar loops
      if (options.fromScanner) stopScanner();
      return;
    }

    // push y guardar
    regs[todayStr][qrCode].push(selectedMeal);
    saveRegistrations(regs);

    // Notificaci√≥n con iziToast (m√°s visible que el mensaje en pantalla)
    iziToast.success({
      title: 'Registrado',
      message: `${getMealName(selectedMeal)} registrado para ${qrCode.substring(0,12)}...`,
      position: 'topCenter',
      timeout: 2500
    });

    // Actualizar UI
    loadHistory();
    loadPeopleList();
    updateStats();

    // Si fue por scanner, detener la c√°mara autom√°ticamente (es lo que pediste)
    if (options.fromScanner) {
      // peque√±o delay visual para que el usuario vea que registr√≥ antes de ocultar la c√°mara
      setTimeout(() => stopScanner(), 250);
    }
  }

  /* -------------------------
     Fecha y localStorage
     ------------------------- */
  function getTodayDate() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function getRegistrations() {
    const raw = localStorage.getItem(STORAGE_KEY);
    try {
      return raw ? JSON.parse(raw) : {};
    } catch (e) {
      console.error('localStorage corrupto, reseteando:', e);
      localStorage.removeItem(STORAGE_KEY);
      return {};
    }
  }

  function saveRegistrations(obj) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }

  /* -------------------------
     Clean old records
     ------------------------- */
  function cleanOldRecords() {
    const regs = getRegistrations();
    const today = new Date();
    const cutoff = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    cutoff.setDate(cutoff.getDate() - DAYS_TO_KEEP);

    let changed = false;
    Object.keys(regs).forEach(dateStr => {
      const recordDate = new Date(dateStr + 'T00:00:00');
      if (recordDate < cutoff) {
        delete regs[dateStr];
        changed = true;
      }
    });

    if (changed) saveRegistrations(regs);
  }

  /* -------------------------
     UI: People list & filter
     ------------------------- */
  function loadPeopleList() {
    const regs = getRegistrations();
    const today = getTodayDate();
    const todayData = regs[today] || {};
    const container = document.getElementById('people-container');
    container.innerHTML = '';

    if (Object.keys(todayData).length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No hay personas registradas hoy</p>';
      return;
    }

    const sorted = Object.entries(todayData).sort((a,b) => b[1].length - a[1].length);
    sorted.forEach(([code, meals]) => {
      const card = document.createElement('div');
      card.className = 'person-card';
      card.dataset.code = code;

      const allMeals = ['desayuno','almuerzo','comida'];
      let tags = '';
      allMeals.forEach(m => {
        if (meals.includes(m)) tags += `<span class="meal-tag ${m}">${getMealName(m)}</span>`;
        else tags += `<span class="meal-tag pendiente">${getMealName(m)}</span>`;
      });

      const completed = meals.length;
      card.innerHTML = `
        <div class="person-header">
          <div class="person-code">${code.substring(0,16)}${code.length>16?'...':''}</div>
          <div class="person-date">${completed}/3 comidas</div>
        </div>
        <div class="meal-tags">${tags}</div>
      `;
      container.appendChild(card);
    });
  }

  function filterPeople() {
    const term = (document.getElementById('search-input').value || '').toLowerCase();
    document.querySelectorAll('.person-card').forEach(card => {
      const code = (card.dataset.code || '').toLowerCase();
      card.style.display = code.includes(term) ? 'block' : 'none';
    });
  }

  /* -------------------------
     Stats & History
     ------------------------- */
  function updateStats() {
    const regs = getRegistrations();
    const today = getTodayDate();
    const todayData = regs[today] || {};
    const totalPeople = Object.keys(todayData).length;
    let totalMeals = 0, pendingMeals = 0;
    Object.values(todayData).forEach(arr => { totalMeals += arr.length; pendingMeals += (3 - arr.length); });

    document.getElementById('total-people').textContent = totalPeople;
    document.getElementById('total-meals').textContent = totalMeals;
    document.getElementById('pending-meals').textContent = pendingMeals;
  }

  function loadHistory() {
    const regs = getRegistrations();
    const list = document.getElementById('history-list');
    list.innerHTML = '';

    const dates = Object.keys(regs).sort().reverse();
    if (dates.length === 0) { list.innerHTML = '<p style="text-align:center;color:#999;">No hay registros todav√≠a</p>'; return; }

    dates.forEach(date => {
      const dateObj = new Date(date + 'T00:00:00');
      const formatted = dateObj.toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      const qrCodes = regs[date];
      const totalPeople = Object.keys(qrCodes).length;
      const totalMeals = Object.values(qrCodes).reduce((acc, arr) => acc + arr.length, 0);

      const mealCount = { desayuno:0, almuerzo:0, comida:0 };
      Object.values(qrCodes).forEach(arr => arr.forEach(m => { if (mealCount.hasOwnProperty(m)) mealCount[m]++; }));

      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `
        <div class="date">${formatted}</div>
        <div style="font-size:13px;color:#666;margin-top:8px;">
          <strong>${totalPeople}</strong> personas ‚Ä¢ <strong>${totalMeals}</strong> comidas registradas
        </div>
        <div style="display:flex;gap:10px;margin-top:10px;font-size:12px;">
          <span style="color:#ff9800;">üåÖ Desayunos: ${mealCount.desayuno}</span>
          <span style="color:#4caf50;">‚òÄÔ∏è Almuerzos: ${mealCount.almuerzo}</span>
          <span style="color:#2196f3;">üåô Comidas: ${mealCount.comida}</span>
        </div>
      `;
      list.appendChild(item);
    });
  }

  /* -------------------------
     Clear old data (manual)
     ------------------------- */
  function clearOldData() {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar todos los datos antiguos (m√°s de 3 d√≠as)?')) return;
    cleanOldRecords();
    loadHistory();
    loadPeopleList();
    updateStats();
    iziToast.success({ title: 'Hecho', message: 'Datos antiguos eliminados', position: 'topCenter' });
  }

  </script>
</body>
</html>
